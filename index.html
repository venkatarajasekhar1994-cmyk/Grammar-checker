<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bilingual Grammar & Sentence Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .result-card { border-left-width: 4px; }
        .result-card-error { border-left-color: #EF4444; } /* red-500 */
        .result-card-correct { border-left-color: #22C55E; } /* green-500 */
        .highlight-error { background-color: #FEE2E2; color: #DC2626; padding: 0 4px; border-radius: 3px; font-family: monospace; }
        .highlight-correct { background-color: #ECFDF5; color: #047857; padding: 0 4px; border-radius: 3px; font-weight: bold; font-family: monospace;}
        /* Added style for loading message */
        #loading-message {
            display: none; /* Hidden by default */
            text-align: center;
            padding: 1rem;
            color: #4B5563; /* gray-600 */
            font-style: italic;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold text-center text-blue-600 mb-6">Bilingual Grammar & Sentence Checker</h1>
        <p class="text-gray-600 mb-6 text-center">
            Enter your English text below. This tool checks for common grammar errors using a custom-built dictionary and rule set.
        </p>

        <div class="mb-4">
            <label for="text-input" class="block text-sm font-medium text-gray-700 mb-2">Your Text:</label>
            <textarea id="text-input" rows="12" class="w-full p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Yesterday I goes to market..."></textarea>
        </div>

        <div class="text-center mb-6">
            <button id="check-button" class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-10 rounded-lg shadow-md hover:bg-blue-700 transition duration-300" disabled>
                Loading Dictionary...
            </button>
        </div>

        <div>
            <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 mb-4">Results:</h2>
            <div id="loading-message">
                Loading data from JSON files... Please wait.
            </div>
            <div id="results-output" class="space-y-4">
                <p id="no-errors-message" class="text-gray-500 italic">Please wait for the dictionary to load, then click "Check Grammar" to start!</p>
            </div>
        </div>
    </div>

    <script>
        // --- OUR CUSTOM "BRAIN" (మన సొంత "మెదడు") ---
        // ఇది ఇప్పుడు ఖాళీగా ప్రారంభమవుతుంది మరియు ఫైల్స్ నుండి డేటాను లోడ్ చేస్తుంది
        let wordData = {};

        const checkButton = document.getElementById('check-button');
        const textInput = document.getElementById('text-input');
        const resultsOutput = document.getElementById('results-output');
        const loadingMessage = document.getElementById('loading-message');
        const noErrorsMessage = document.getElementById('no-errors-message');

        // --- NEW DYNAMIC DATA LOADING ---

        // Function to fetch a JSON file
        async function fetchJSON(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to load ${url}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(error);
                return {}; // Return empty object on error
            }
        }

        // Function to load all data files and merge them
        async function loadAllData() {
            console.log('Starting data load...');
            loadingMessage.style.display = 'block';
            noErrorsMessage.textContent = 'Loading dictionary... Please wait.';

            const [verbs, dictionary, nouns] = await Promise.all([
                fetchJSON('verbs.json'),
                fetchJSON('dictionary.json'),
                fetchJSON('singular_plural_words.json')
            ]);

            // Merge all data into the main wordData object
            Object.assign(wordData, dictionary, verbs, nouns);

            const totalWords = Object.keys(wordData).length;
            if (totalWords > 0) {
                console.log(`Brain loaded! Total words: ${totalWords}`);
                checkButton.disabled = false;
                checkButton.textContent = 'Check Grammar';
                loadingMessage.style.display = 'none';
                noErrorsMessage.textContent = 'No issues found yet. Click "Check Grammar" to start!';
            } else {
                console.error('All JSON files failed to load or are empty.');
                checkButton.textContent = 'Error: Dictionary Failed';
                loadingMessage.textContent = 'Error: Could not load dictionary files. Please check console.';
                noErrorsMessage.textContent = 'Could not load data. Please ensure verbs.json, dictionary.json, and singular_plural_words.json are in the same folder.';
            }
        }

        // Load data when the window is ready
        window.addEventListener('DOMContentLoaded', loadAllData);
        
        // --- END OF NEW LOADING LOGIC ---


        // --- APPLICATION LOGIC (Smarter v7 with Full Sentence Correction) ---
        
        checkButton.addEventListener('click', checkGrammar);
        
        // Helper to match original word case
        function replaceWithSameCase(original, suggestion) {
            if (!original || !suggestion) return suggestion;

            // Case 1: ALL CAPS
            if (original === original.toUpperCase()) {
                return suggestion.toUpperCase();
            }
            
            // Case 2: Title Case (First letter capitalized, rest lowercase)
            if (original.charAt(0) === original.charAt(0).toUpperCase() && original.slice(1) === original.slice(1).toLowerCase()) {
                 return suggestion.charAt(0).toUpperCase() + suggestion.slice(1).toLowerCase();
            }
            
            // Default: return suggestion as-is (likely lowercase)
            return suggestion;
        }


        function checkGrammar() {
            const text = textInput.value;
            resultsOutput.innerHTML = ''; // Clear previous results
            let errorsFound = 0;
            let overallErrors = 0; // To track total errors across all sentences

            const sentences = text.match(/[^.!?]+[.!?]*/g) || [text]; // Split into sentences
            
            sentences.forEach(sentence => {
                let originalSentence = sentence.trim();
                if (!originalSentence) return;
                
                errorsFound = 0; // Reset for each sentence
                let hasCorrections = false; // Track if we made simple replacements
                
                // Store words with original punctuation for accurate suggestions
                const wordsWithPunct = originalSentence.split(/(\s+)/); // Split but keep spaces
                let correctedWords = [...wordsWithPunct]; // Copy for modifications
                const cleanWords = originalSentence.toLowerCase().split(/\s+/).map(w => w.replace(/[.,!?]/g, ''));
                
                let requiredTense = "Present"; // Default
                let subject = null;
                let subjectWord = "";
                let subjectIndex = -1;
                let lastVerbIndex = -1; // To link tense errors to verbs

                // --- 1. Tense Check (కాలం తనిఖీ) ---
                // "Yesterday", "last night" వంటి పదాల కోసం వాక్యం మొత్తం తనిఖీ చేయండి
                for (const word of cleanWords) {
                    if (wordData[word]?.type === "TenseIndicator" && wordData[word].tense === "Past") {
                        requiredTense = "Past";
                        break;
                    }
                }

                // --- 2. Iterate through words to find errors ---
                for (let i = 0; i < cleanWords.length; i++) {
                    const word = cleanWords[i];
                    const data = wordData[word];
                    
                    if (!data) continue; // Word not in our dictionary

                    // Find Subject (కర్తను కనుగొనండి)
                    if (!subject && (data.type === "Noun" || data.type === "Pronoun") && data.form !== "Object") {
                        subject = data;
                        subjectWord = wordsWithPunct[i*2].replace(/[.,!?]/g, ''); // Original case
                        subjectIndex = i;
                    }

                    // --- ERROR CHECKS (తప్పుల తనిఖీ) ---

                    // A. Tense Error (కాలం తప్పు)
                    // e.g., "Yesterday I *goes*..." or "We *is watching* movie last night"
                    if (requiredTense === "Past" && data.type === "Verb" && data.tense === "Present") {
                        if (subject && i > subjectIndex) { // Verb must follow subject
                            errorsFound++;
                            const originalVerb = wordsWithPunct[i*2];
                            
                            // Determine correct past tense verb
                            let correctVerb = data.v2; // e.g., "goes" -> "went", "don't" -> "didn't"
                            if (!correctVerb) {
                                if (word === 'is') correctVerb = 'was';
                                else if (word === 'are') correctVerb = 'were';
                                else if (data.base) correctVerb = data.base + 'ed'; // Simple guess
                            }
                            // Fallback for words like 'cooks' which might not have v2 defined
                            if (!correctVerb && data.base) correctVerb = data.base + 'ed'; 
                            
                            if (correctVerb) {
                                correctedWords[i*2] = replaceWithSameCase(originalVerb, correctVerb);
                                hasCorrections = true;
                                displayError(
                                    `Found Issue: <span class="highlight-error">${originalVerb}</span> (with 'Yesterday'/'last')`,
                                    "Past Tense Error (గత కాలం తప్పు)",
                                    `The sentence indicates past time (e.g., 'Yesterday', 'last night'), but you used a present tense verb.`,
                                    `వాక్యం గతాన్ని సూచిస్తుంది, కానీ మీరు వర్తమాన కాల క్రియను ఉపయోగించారు.`,
                                    `మీరు బహుశా ఇలా చెప్పాలనుకున్నారు: <span class="highlight-correct">${correctVerb}</span>`
                                );
                            }
                            // DO NOT reset subject: subject = null;
                        }
                    }

                    // B. Misspelled/Irregular Verb Error (తప్పు క్రియ)
                    // e.g., "...I *buyed*..." or "...He *runned*..."
                    if (data.type === "Verb" && data.form === "Misspelled") {
                         errorsFound++;
                         const suggestedWord = data.correct;
                         correctedWords[i*2] = replaceWithSameCase(wordsWithPunct[i*2], suggestedWord);
                         hasCorrections = true;
                         displayError(
                            `Found Issue: <span class="highlight-error">${wordsWithPunct[i*2]}</span>`,
                            "Irregular Verb Error (క్రమరహిత క్రియ తప్పు)",
                            `'${word}' is not the correct past tense for '${data.base}'.`,
                            `'${data.base}' యొక్క సరైన గత కాల రూపం '${word}' కాదు.`,
                            `మీరు బహుశా ఇలా చెప్పాలనుకున్నారు: <span class="highlight-correct">${suggestedWord}</span>`
                        );
                    }
                    
                    // C. V2/V3 Confusion (V2/V3 గందరగోళం)
                    // e.g., "I *seen*..."
                    if (data.type === "Verb" && data.form === "PastParticiple" && subject && i > subjectIndex) {
                        if (cleanWords[i-1] !== 'have' && cleanWords[i-1] !== 'has' && cleanWords[i-1] !== 'had') {
                             errorsFound++;
                             const suggestedWord = data.v2;
                             correctedWords[i*2] = replaceWithSameCase(wordsWithPunct[i*2], suggestedWord);
                             hasCorrections = true;
                             displayError(
                                `Found Issue: <span class="highlight-error">${wordsWithPunct[i*2]}</span>`,
                                "Verb Form Error (క్రియా రూపం తప్పు)",
                                `'${word}' (V3) needs a helping verb (have, has, had). You probably mean the simple past tense (V2).`,
                                `'${word}' (V3)కు సహాయక క్రియ అవసరం. మీరు V2 రూపాన్ని వాడాలనుకుంటున్నారు.`,
                                `మీరు బహుశా ఇలా చెప్పాలనుకున్నారు: <span class="highlight-correct">${suggestedWord}</span>`
                            );
                             // DO NOT reset subject: subject = null;
                        }
                    }

                    // D. Subject-Verb Agreement (SVA) Error (కర్త-క్రియ ఒప్పందం తప్పు)
                    // e.g., "apples *is*..." or "She *don't*..." or "I *has*..."
                    // This rule should NOT run if a Tense Error was already found for this word
                    if (data.type === "Verb" && data.tense === "Present" && requiredTense !== "Past" && subject && i > subjectIndex) {
                        const originalVerb = wordsWithPunct[i*2];
                        // Check for singular subject (he, she, it, man, teacher) + plural verb (go, have, are)
                        if (subject.form === "Singular" && subject.special !== "I" && data.form === "Plural") {
                             errorsFound++;
                             // Find the correct singular form (v5 or singular property)
                             const suggestedWord = data.v5 || data.singular || (data.base ? data.base + 's' : word + 's');
                             correctedWords[i*2] = replaceWithSameCase(originalVerb, suggestedWord);
                             hasCorrections = true;
                             displayError(
                                `Found Issue: <span class="highlight-error">${subjectWord} ${originalVerb}</span>`,
                                "Subject-Verb Agreement Error",
                                `A singular subject (ఏకవచన కర్త) like '${subjectWord}' needs a singular verb.`,
                                `'${subjectWord}' ఏకవచనం, కాబట్టి ఏకవచన క్రియ వాడాలి.`,
                                `మీరు బహుశా ఇలా చెప్పాలనుకున్నారు: <span class="highlight-correct">${suggestedWord}</span>`
                            );
                        // Check for plural subject (they, we, men, teachers) + singular verb (goes, has, is)
                        } else if (subject.form === "Plural" && data.form === "Singular") {
                             errorsFound++;
                             const suggestedWord = data.plural || data.base;
                             correctedWords[i*2] = replaceWithSameCase(originalVerb, suggestedWord);
                             hasCorrections = true;
                             displayError(
                                `Found Issue: <span class="highlight-error">${subjectWord} ${originalVerb}</span>`,
                                "Subject-Verb Agreement Error",
                                `A plural subject (బహువచన కర్త) like '${subjectWord}' needs a plural verb.`,
                                `'${subjectWord}' బహువచనం, కాబట్టి బహువచన క్రియ వాడాలి.`,
                                `మీరు బహుశా ఇలా చెప్పాలనుకున్నారు: <span class="highlight-correct">${suggestedWord}</span>`
                            );
                        } else if (subject.special === "I" && (word === "is" || word === "has" || (data.form === "Singular" && word !== 'am'))) {
                             // Special case for "I" (e.g. "I is", "I has", "I goes")
                             errorsFound++;
                             let suggestedWord = data.plural || data.base;
                             if (word === 'is') suggestedWord = 'am';
                             if (word === 'has') suggestedWord = 'have';
                             
                             correctedWords[i*2] = replaceWithSameCase(originalVerb, suggestedWord);
                             hasCorrections = true;
                             displayError(
                                `Found Issue: <span class="highlight-error">I ${originalVerb}</span>`,
                                "Subject-Verb Agreement Error",
                                `The pronoun 'I' is used with 'am', 'have', or the base verb (e.g., 'go').`,
                                `'I' తో 'am', 'have', లేదా బహువచన క్రియ (go) వాడాలి.`,
                                `మీరు బహుశా ఇలా చెప్పాలనుకున్నారు: <span class="highlight-correct">I ${suggestedWord}</span>`
                            );
                        }
                    }
                    
                    // E. SVA Error with "was/were"
                    if (data.type === "Verb" && data.tense === "Past" && (word === 'was' || word === 'were') && subject && i > subjectIndex) {
                         if (subject.form === "Singular" && subject.special !== "I" && word === "were") {
                             errorsFound++;
                             correctedWords[i*2] = replaceWithSameCase(wordsWithPunct[i*2], "was");
                             hasCorrections = true;
                             displayError(
                                `Found Issue: <span class="highlight-error">${subjectWord} were</span>`,
                                "Subject-Verb Agreement Error",
                                `A singular subject (ఏకవచన కర్త) like '${subjectWord}' needs the singular verb 'was'.`,
                                `'${subjectWord}' ఏకవచనం, కాబట్టి 'was' వాడాలి.`,
                                `మీరు బహుశా ఇలా చెప్పాలనుకున్నారు: <span class="highlight-correct">was</span>`
                            );
                         } else if (subject.form === "Plural" && word === "was") {
                             errorsFound++;
                             correctedWords[i*2] = replaceWithSameCase(wordsWithPunct[i*2], "were");
                             hasCorrections = true;
                             displayError(
                                `Found Issue: <span class="highlight-error">${subjectWord} was</span>`,
                                "Subject-Verb Agreement Error",
                                `A plural subject (బహువచన కర్త) like '${subjectWord}' needs the plural verb 'were'.`,
                                `'${subjectWord}' బహువచనం, కాబట్టి 'were' వాడాలి.`,
                                `మీరు బహుశా ఇలా చెప్పాలనుకున్నారు: <span class="highlight-correct">were</span>`
                            );
                         }
                    }
                    
                    // F. Irregular Plural Error
                    if (data.type === "Noun" && data.form === "Misspelled") {
                        errorsFound++;
                         const suggestedWord = data.correct;
                         correctedWords[i*2] = replaceWithSameCase(wordsWithPunct[i*2], suggestedWord);
                         hasCorrections = true;
                         displayError(
                            `Found Issue: <span class="highlight-error">${wordsWithPunct[i*2]}</span>`,
                            "Irregular Plural Error (క్రమరహిత బహువచన తప్పు)",
                            `The plural of '${word.slice(0, -1)}' is not '${word}'.`,
                            `'${word.slice(0, -1)}' యొక్క బహువచనం '${word}' కాదు.`,
                            `మీరు బహుశా ఇలా చెప్పాలనుకున్నారు: <span class="highlight-correct">${suggestedWord}</span>`
                        );
                    }
                    
                    // G. Uncountable Noun Error
                    if (data.type === "Noun" && data.form === "Misspelled" && (cleanWords[i-1] === 'some' || cleanWords[i-1] === 'delicious')) {
                        errorsFound++;
                         const suggestedWord = data.correct;
                         correctedWords[i*2] = replaceWithSameCase(wordsWithPunct[i*2], suggestedWord);
                         hasCorrections = true;
                         displayError(
                            `Found Issue: <span class="highlight-error">${wordsWithPunct[i*2]}</span>`,
                            "Uncountable Noun Error (లెక్కించలేని నామవాచకం)",
                            `'${data.correct}' is usually an uncountable noun and doesn't have a plural form 's'.`,
                            `'${data.correct}' సాధారణంగా లెక్కించలేనిది, దానికి 's' ఉండదు.`,
                            `మీరు బహుశా ఇలా చెప్పాలనుకున్నారు: <span class="highlight-correct">${suggestedWord}</span>`
                        );
                    }
                    
                    // H. Gerund Error (e.g., "like to eating")
                    if (word === "to" && cleanWords[i+1] && wordData[cleanWords[i+1]]?.form === "Progressive") {
                        if (cleanWords[i-1] === "like") { // like to eating
                            errorsFound++;
                            // This is a complex correction, so we don't modify correctedWords[]
                            displayError(
                                `Found Issue: <span class="highlight-error">like to ${cleanWords[i+1]}</span>`,
                                "Gerund/Infinitive Error",
                                `After 'like', you can use 'to' + base verb (to eat) or just the '-ing' form (eating), but not both.`,
                                `'like' తర్వాత, 'to eat' లేదా 'eating' వాడవచ్చు, కానీ 'to eating' వాడకూడదు.`,
                                `మీరు బహుశా ఇలా చెప్పాలనుకున్నారు: <span class="highlight-correct">like to eat</span> / <span class="highlight-correct">like eating</span>`
                            );
                        }
                    }
                    
                    // I. Missing Preposition (e.g., "going store")
                    if (data.type === "Verb" && word === "going" && cleanWords[i+1] && wordData[cleanWords[i+1]]?.type === "Noun") {
                        if(wordData[cleanWords[i+1]].form === "Singular") {
                             errorsFound++;
                             // Complex correction
                             displayError(
                                `Found Issue: <span class="highlight-error">going ${cleanWords[i+1]}</span>`,
                                "Missing Preposition Error (ప్రిపోజిషన్ లేదు)",
                                `When 'going' is followed by a place, you usually need 'to' (e.g., 'going *to* the store').`,
                                `'going' తర్వాత ఒక స్థలం వస్తే, 'to' వాడాలి.`,
                                `మీరు బహుశా ఇలా చెప్పాలనుకున్నారు: <span class="highlight-correct">going to the ${cleanWords[i+1]}</span>`
                            );
                        }
                    }
                    
                    // J. Wrong Pronoun (e.g., "boy which")
                    if (data.type === "Pronoun" && word === "which" && subject && subject.type === "Noun" && (subjectWord === "boy" || subjectWord === "person")) {
                         errorsFound++;
                         // Complex correction
                         displayError(
                            `Found Issue: <span class="highlight-error">boy which</span>`,
                            "Pronoun Error (సర్వనామం తప్పు)",
                            `Use 'who' or 'that' for people. 'Which' is used for things or animals.`,
                            `మనుషులకు 'who' లేదా 'that' వాడాలి. 'Which' వస్తువులకు వాడతారు.`,
                            `మీరు బహుశా ఇలా చెప్పాలనుకున్నారు: <span class="highlight-correct">boy who</span>`
                        );
                    }
                    
                    // Reset subject after a conjunction (e.g., and, but)
                    if (data.type === "Conjunction") {
                        subject = null;
                        subjectIndex = -1;
                        subjectWord = "";
                    }
                }
                
                // --- 3. Display Full Corrected Sentence (NEW) ---
                if (errorsFound > 0 && hasCorrections) {
                    displayFullCorrection(correctedWords.join(''), originalSentence);
                }
                
                overallErrors += errorsFound;
            });

            // Final check
            if (overallErrors === 0) {
                // Clear the "No issues found" message if it exists
                const noErrorsMsg = document.getElementById('no-errors-message');
                if (noErrorsMsg) noErrorsMsg.remove();
                
                resultsOutput.innerHTML = `
                    <div class="result-card result-card-correct bg-green-50 p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-green-800">All Clear!</p>
                        <p class="text-sm text-gray-700">The checker didn't find any issues based on its current rules.</p>
                    </div>`;
            } else {
                 // Remove the "No issues found" message if any errors were found
                const noErrorsMsg = document.getElementById('no-errors-message');
                if (noErrorsMsg) noErrorsMsg.remove();
            }
        }

        // Helper function to display the full corrected sentence
        function displayFullCorrection(correctedSentence, originalSentence) {
            const correctionCard = document.createElement('div');
            correctionCard.className = 'result-card result-card-correct bg-green-50 p-4 rounded-lg shadow-sm mb-4';
            
            correctionCard.innerHTML = `
                <p class="font-semibold text-green-800">Suggested Full Sentence (Best Effort):</p>
                <p class="text-sm text-gray-500 line-through">Original: ${originalSentence}</p>
                <p class="text-lg text-gray-900 font-medium">${correctedSentence}</p>
                <p class="text-xs text-gray-600 mt-2"><strong>Note:</strong> This is an automated correction. For complex errors (like "didn't went"), it might still be incorrect. Always review the individual error cards below.</p>
            `;
            
            // Add this card to the top of the results for prominence
            if (resultsOutput.firstChild) {
                resultsOutput.insertBefore(correctionCard, resultsOutput.firstChild);
            } else {
                resultsOutput.appendChild(correctionCard);
            }
        }

        // Helper function to display errors
        function displayError(issue, rule, englishRule, teluguRule, suggestion) {
             // Remove the "No issues found" message if it exists
            const noErrorsMsg = document.getElementById('no-errors-message');
            if (noErrorsMsg) noErrorsMsg.remove();
            
            const errorCard = document.createElement('div');
            errorCard.className = 'result-card result-card-error bg-red-50 p-4 rounded-lg shadow-sm';
            
            errorCard.innerHTML = `
                <p class="font-semibold text-red-800">${issue}</p>
                <hr class="my-2 border-red-200">
                <p class="text-sm text-gray-700"><strong>Rule:</strong> ${rule}</p>
                <p class="text-sm text-gray-600">${englishRule}</p>
                <p class="text-sm text-gray-700"><strong>వివరణ (Rule):</strong> ${teluguRule}</p>
                <p class="text-sm text-green-700 mt-2"><strong>Suggestion (సూచన):</strong> ${suggestion}</p>
            `;
            
            resultsOutput.appendChild(errorCard);
        }

    </script>

</body>
</html>
