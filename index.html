<meta name='viewport' content='width=device-width, initial-scale=1'/><meta name='viewport' content='width=device-width, initial-scale=1'/><meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notepad</title>
    
    <link rel="manifest" href="manifest.json">
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').catch(e => console.error('SW Init Error:', e));
            });
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <style>
        /* --- FONTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lora:ital,wght@0,400;0,700;1,400&family=Roboto:wght@400;700&family=Merriweather:wght@300;400;700&family=Montserrat:wght@400;700;900&family=Poppins:wght@400;600;700&family=Source+Sans+3:wght@400;700&family=DM+Sans:wght@400;700&family=DM+Serif+Display&family=Lexend:wght@400;700&display=swap');
        
        :root {
            --title-font: 'Montserrat', sans-serif;
            --body-font: 'Lexend', sans-serif;
            --accent-color-rgb: 79, 70, 229; --accent-color-hex: #4f46e5;
            --bg-grad-color1: #a5b4fc; --bg-grad-color2: #818cf8; --bg-grad-color3: #6366f1; --bg-grad-color4: #4f46e5;
            --glass-bg: rgba(255, 255, 255, 0.1); --glass-border: rgba(255, 255, 255, 0.2);
            --button-bg: rgba(0, 0, 0, 0.1); --button-hover-bg: rgba(0, 0, 0, 0.2);
            --modal-bg: rgba(255, 255, 255, 0.05);
            --text-main: #f3f4f6; --text-subtle: #d1d5db;
        }
        .dark:root {
            --bg-grad-color1: #312e81; --bg-grad-color2: #4338ca; --bg-grad-color3: #4f46e5; --bg-grad-color4: #6366f1;
            --glass-bg: rgba(31, 41, 55, 0.4); --glass-border: rgba(255, 255, 255, 0.1);
            --button-bg: rgba(0, 0, 0, 0.3); --button-hover-bg: rgba(0, 0, 0, 0.5);
            --modal-bg: rgba(17, 24, 39, 0.6);
            --text-main: #f9fafb; --text-subtle: #9ca3af;
        }

        /* High Contrast Mode Override */
        body[data-contrast="high"] { --text-main: #000000; --text-subtle: #333333; }
        .dark body[data-contrast="high"] { --text-main: #ffffff; --text-subtle: #e5e5e5; }

        /* Standard Mode Styles */
        body { color: var(--text-main); font-family: var(--body-font); background: linear-gradient(-45deg, var(--bg-grad-color1), var(--bg-grad-color2), var(--bg-grad-color3), var(--bg-grad-color4)); background-size: 400% 400%; animation: gradientBG 15s ease infinite; transition: all 0.5s ease; min-height: 100vh; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        /* --- READ MODE STYLES --- */
        body.read-mode { background: #f5f5f5 !important; animation: none !important; color: #333 !important; }
        .dark body.read-mode { background: #050505 !important; color: #e0e0e0 !important; }
        .read-mode #app { max-width: 900px !important; }
        
        /* Light Paper Container */
        .read-mode .input-container {
            background-color: #ffffff !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
            border: 1px solid #e5e7eb !important;
            backdrop-filter: none !important;
            border-radius: 8px !important;
        }
        /* Dark Paper Container */
        .dark .read-mode .input-container {
            background-color: #0a0a0a !important; 
            border-color: #202020 !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5) !important;
        }

        /* Light Lines */
        .read-mode #grammar-input {
             background-color: transparent !important; border: none !important;
             background-image: linear-gradient(transparent 95%, #e5e7eb 95%) !important;
             background-size: 100% 2.5rem; line-height: 2.5rem !important; padding-top: 0.5rem !important;
             font-family: 'Lora', serif !important; font-size: 1.15rem !important; color: #2d3748 !important;
        }
        /* Dark Lines */
        .dark .read-mode #grammar-input {
            background-image: linear-gradient(transparent 95%, #202020 95%) !important;
            color: #e2e8f0 !important;
        }
        
        /* Mic Button in Read Mode */
        .read-mode #mic-button { display: flex !important; color: #a0aec0 !important; background: transparent !important; }
        .dark .read-mode #mic-button { color: #6b7280 !important; }
        .read-mode #mic-button:hover, .read-mode #mic-button.mic-active { color: var(--accent-color-hex) !important; background: rgba(0,0,0,0.05) !important; }
        .dark .read-mode #mic-button:hover, .dark .read-mode #mic-button.mic-active { background: rgba(255,255,255,0.05) !important; }

        /* Neutral Check Button in Read Mode */
        .read-mode #check-grammar-btn { background-color: #4a5568 !important; color: #e2e8f0 !important; }
        .dark .read-mode #check-grammar-btn { background-color: #2d3748 !important; color: #e2e8f0 !important; }

        /* Exit Read Mode Button */
        #exit-read-mode-btn { display: none; position: fixed; bottom: 20px; right: 20px; z-index: 50; background-color: rgba(0,0,0,0.7); color: white; padding: 12px; border-radius: 50%; backdrop-filter: blur(5px); transition: all 0.3s ease; }
        .read-mode #exit-read-mode-btn { display: flex !important; }
        .dark .read-mode #exit-read-mode-btn { background-color: rgba(255,255,255,0.15) !important; }
        #exit-read-mode-btn:hover { transform: scale(1.1); }

        /* --- UTILITY CLASSES --- */
        .accent-bg { background-color: rgb(var(--accent-color-rgb)); } .accent-text { color: rgb(var(--accent-color-rgb)); }
        .glass-effect { background: var(--glass-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--glass-border); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); transition: all 0.3s ease; }
        .button-bg-color { background-color: var(--button-bg); transition: background-color 0.2s ease; } .button-bg-color:hover { background-color: var(--button-hover-bg); }
        .modal-glass { background: var(--modal-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--glass-border); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4); }
        .selection-button { background-color: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.2s; } .selection-button.active { border-color: rgb(var(--accent-color-rgb)); background-color: rgba(var(--accent-color-rgb), 0.2); font-weight: 600; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-left-color: #fff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 1rem auto; } @keyframes spin { to { transform: rotate(360deg); } }
        .speak-button { @apply p-2 rounded-full hover:bg-white/20 transition-colors text-gray-300 hover:text-white flex-shrink-0; }
        .mic-active { animation: pulse-red 1.5s infinite; color: #ef4444 !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        input::placeholder, textarea::placeholder { color: var(--text-subtle); opacity: 0.7; }
        .read-mode input::placeholder, .read-mode textarea::placeholder { color: #a0aec0 !important; opacity: 0.8; }
        .dark .read-mode input::placeholder, .dark .read-mode textarea::placeholder { color: #6b7280 !important; opacity: 0.6; }
    </style>
</head>
<body class="transition-colors duration-500">

    <button id="exit-read-mode-btn" onclick="toggleReadMode()" aria-label="Exit Read Mode" title="Exit Read Mode">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6 transition-all duration-500">
        
        <header class="flex items-center justify-between mb-6 transition-opacity duration-500">
            <div class="flex items-center overflow-hidden mr-2">
                 <a href="game hub.html" class="mr-3 p-2 rounded-full text-gray-200 hover:text-white transition-colors glass-effect md:hidden flex-shrink-0" aria-label="Back to Hub">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                </a>
                <h1 id="app-title" class="text-2xl md:text-4xl font-bold text-white shadow-sm truncate font-title">Notepad</h1>
            </div>
            <div class="flex items-center space-x-1 md:space-x-2 flex-shrink-0">
                <button id="read-mode-toggle" class="flex items-center space-x-2 px-3 py-2 rounded-full text-gray-100 bg-white/10 hover:bg-white/20 transition-all border border-white/10 hover:border-white/30" title="Toggle Read Mode">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                    <span class="hidden sm:inline text-sm font-semibold">Read Mode</span>
                </button>
                 <a href="game hub.html" class="hidden md:flex text-gray-200 hover:text-white transition-colors p-2 rounded-full glass-effect" aria-label="Go to Hub">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </a>
                <button id="settings-button" class="p-2 rounded-full text-gray-200 hover:text-white transition-colors glass-effect" aria-label="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full text-gray-200 hover:text-white transition-colors glass-effect" aria-label="Theme">
                    <svg id="theme-icon-light" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                    <svg id="theme-icon-dark" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    <svg id="theme-icon-system" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
                </button>
            </div>
        </header>

        <main class="fade-in space-y-6 transition-all duration-500">
            
            <div class="input-container p-6 rounded-2xl glass-effect shadow-xl flex flex-col transition-all duration-500">
                 <div class="relative flex-grow h-full">
                     <textarea id="grammar-input" class="w-full p-6 pr-14 rounded-xl bg-black/20 border-2 border-white/10 focus:border-indigo-400/50 focus:ring-0 text-white placeholder-gray-400 resize-y transition-all text-xl leading-relaxed min-h-[60vh]" placeholder="Start writing here..."></textarea>
                     
                     <button id="mic-button" class="absolute right-4 bottom-4 p-3 rounded-full bg-white/10 hover:bg-white/20 text-white transition-all flex items-center justify-center z-10" aria-label="Start speech recognition" title="Speak Now">
                         <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                     </button>
                 </div>
                 <button id="check-grammar-btn" class="w-full mt-4 accent-bg text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:opacity-90 transition-all flex items-center justify-center text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                     <span>Check Grammar</span>
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-2"><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></svg>
                 </button>
            </div>

            <div id="grammar-loading" class="hidden text-center py-8 fade-in">
                 <div class="spinner"></div>
                 <p class="text-white opacity-80 animate-pulse font-medium">Analyzing your text...</p>
             </div>

            <div id="grammar-results" class="hidden space-y-4 fade-in">
                <div id="grammar-status" class="p-4 rounded-xl flex items-center justify-center font-bold text-xl text-white shadow-md transition-all font-title"></div>
                <div id="correction-card" class="p-5 rounded-2xl glass-effect border-l-4 border-green-400 hidden shadow-lg">
                    <h3 class="text-xs font-bold text-gray-300 uppercase tracking-wider mb-2 font-title">Corrected Text</h3>
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
                        <p id="corrected-text" class="text-xl md:text-2xl font-bold text-white leading-relaxed font-title whitespace-pre-wrap"></p>
                        <div class="flex space-x-2 flex-shrink-0 self-end md:self-auto">
                             <button id="copy-corrected" class="speak-button" aria-label="Copy to clipboard" title="Copy">
                                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                            </button>
                             <button id="speak-corrected" class="speak-button" aria-label="Speak corrected text" title="Listen">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-5 rounded-2xl button-bg-color shadow-md border border-white/5">
                        <div class="flex justify-between items-center mb-3 pb-2 border-b border-white/10">
                            <h3 class="font-bold text-white flex items-center font-title"><span class="mr-2">ðŸ‡¬ðŸ‡§</span> Coach Explanation</h3>
                             <button id="speak-exp-en" class="speak-button" aria-label="Speak English explanation">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                            </button>
                        </div>
                        <p id="exp-en" class="text-gray-200 text-base leading-relaxed"></p>
                    </div>
                    <div class="p-5 rounded-2xl button-bg-color shadow-md border border-white/5">
                         <div class="flex justify-between items-center mb-3 pb-2 border-b border-white/10">
                            <h3 class="font-bold text-white flex items-center font-title"><span class="mr-2">ðŸ‡®ðŸ‡³</span> à°µà°¿à°µà°°à°£ (Telugu)</h3>
                             <button id="speak-exp-te" class="speak-button" aria-label="Speak Telugu explanation">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                            </button>
                        </div>
                        <p id="exp-te" class="text-gray-200 text-base leading-relaxed"></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="rounded-2xl shadow-xl p-6 w-full max-w-md modal-glass fade-in flex flex-col max-h-[90vh]">
             <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h3 class="text-xl font-bold text-white font-title">Settings</h3>
                <button id="close-settings-modal" class="text-gray-300 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div class="space-y-4 overflow-y-auto no-scrollbar">
                <button id="color-button" class="w-full p-3 rounded-lg text-left button-bg-color hover:button-hover-bg text-white flex justify-between items-center"><div> <span class="text-xs text-gray-400">Accent Color</span><br> <span id="current-accent-color" class="font-semibold"></span> </div> <span id="color-preview" class="w-5 h-5 rounded-full border border-white/20"></span></button>
                <div><span class="text-xs text-gray-400 block mb-1">Theme</span><div class="flex space-x-2"> <button id="theme-light" onclick="handleSelectionChange('theme', 'light')" class="flex-1 py-2 px-3 rounded-lg text-sm selection-button text-white">Light</button><button id="theme-dark" onclick="handleSelectionChange('theme', 'dark')" class="flex-1 py-2 px-3 rounded-lg text-sm selection-button text-white">Dark</button><button id="theme-system" onclick="handleSelectionChange('theme', 'system')" class="flex-1 py-2 px-3 rounded-lg text-sm selection-button text-white">System</button></div></div>
                <div><span class="text-xs text-gray-400 block mb-1">Text Contrast</span><div class="flex space-x-2"><button id="contrast-default" onclick="handleSelectionChange('contrast', 'default')" class="flex-1 py-2 px-3 rounded-lg text-sm selection-button text-white">Default</button><button id="contrast-high" onclick="handleSelectionChange('contrast', 'high')" class="flex-1 py-2 px-3 rounded-lg text-sm selection-button text-white">High Contrast</button></div></div>
                <div><span class="text-xs text-gray-400 block mb-1">Font Combination</span><div id="font-combo-btns" class="grid grid-cols-2 gap-2"><button onclick="applyFontCombination('default1')" data-combo="default1" class="flex-1 py-2 px-3 rounded-lg text-sm selection-button text-white text-center"><strong>Default 1</strong><br><span class="text-xs text-gray-400">Elegant Serif</span></button><button onclick="applyFontCombination('default2')" data-combo="default2" class="flex-1 py-2 px-3 rounded-lg text-sm selection-button text-white text-center"><strong>Default 2</strong><br><span class="text-xs text-gray-400">Modern Sans</span></button></div></div>
                <button id="body-font-button" class="w-full p-3 rounded-lg text-left button-bg-color hover:button-hover-bg text-white"><span class="text-xs text-gray-400">Body Font</span><br> <span id="current-body-font" class="font-semibold"></span></button>
                <button id="title-font-button" class="w-full p-3 rounded-lg text-left button-bg-color hover:button-hover-bg text-white"><span class="text-xs text-gray-400">Title Font</span><br> <span id="current-title-font" class="font-semibold"></span></button>
                <div><span class="text-xs text-gray-400 block mb-1">Feedback</span><div class="space-y-2"><label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg button-bg-color hover:button-hover-bg text-white"><input type="checkbox" id="toggle-audio" onclick="handleSelectionChange('toggleAudio')" class="form-checkbox h-5 w-5 rounded accent-bg border-gray-500 bg-transparent focus:ring-0 text-accent-color-hex"><span>Disable Sound Effects</span></label><label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg button-bg-color hover:button-hover-bg text-white"><input type="checkbox" id="toggle-haptics" onclick="handleSelectionChange('toggleHaptics')" class="form-checkbox h-5 w-5 rounded accent-bg border-gray-500 bg-transparent focus:ring-0 text-accent-color-hex"><span>Disable Vibration</span></label></div></div>
            </div>
        </div>
    </div>
    <div id="selection-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50"><div class="rounded-2xl shadow-xl p-6 w-full max-w-sm max-h-[80vh] flex flex-col modal-glass fade-in"><div class="flex justify-between items-center mb-4"><h3 id="modal-title" class="text-xl font-bold text-white font-title">Select Option</h3><button id="close-selection-modal" class="text-gray-300 hover:text-white text-2xl font-bold" aria-label="Close modal">&times;</button></div><div id="modal-options" class="space-y-2 overflow-y-auto no-scrollbar"></div></div></div>

    <script>
        // --- DOM ELEMENTS ---
        let settingsModal, themeToggle, themeIconLight, themeIconDark, themeIconSystem, readModeToggle;
        let bodyFontBtn, titleFontBtn, colorBtn, currentBodyFont, currentTitleFont, currentAccentColor, colorPreview;
        let contrastDefaultBtn, contrastHighBtn, toggleAudioCheckbox, toggleHapticsCheckbox;
        let themeLightBtn, themeDarkBtn, themeSystemBtn;
        let selectionModal, modalTitle, modalOptions;
        let grammarInput, micButton, checkGrammarBtn, grammarLoading, grammarResults;
        let grammarStatus, correctionCard, correctedTextEl, speakCorrectedBtn, copyCorrectedBtn;
        let expEnEl, expTeEl, speakExpEnBtn, speakExpTeBtn;

        // --- STATE ---
        let disableSound = false, disableVibration = false, isReadMode = false, textContrast = 'default';
        let recognition;
        let systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)');

        // --- CONSTANTS ---
        const SETTINGS_KEY = 'globalHubSettings';
        const FONT_OPTIONS = { body: [{ label: 'Lexend', value: 'Lexend' }, { label: 'DM Sans', value: 'DM Sans' }, { label: 'Poppins', value: 'Poppins' }, { label: 'Inter', value: 'Inter' }, { label: 'Roboto', value: 'Roboto' }, { label: 'Source Sans 3', value: 'Source Sans 3' }, { label: 'Merriweather', value: 'Merriweather' }], title: [{ label: 'Montserrat', value: 'Montserrat' }, { label: 'DM Serif Display', value: 'DM Serif Display' }, { label: 'Outfit', value: 'Outfit' }, { label: 'Lora', value: 'Lora' }, { label: 'Playfair Display', value: 'Playfair Display' }, { label: 'Merriweather', value: 'Merriweather' }] };
        const COLOR_THEMES = [ { name: 'Indigo', value: '79, 70, 229', hex: '#4f46e5', gradient: { light: ['#a5b4fc', '#818cf8', '#6366f1', '#4f46e5'], dark: ['#312e81', '#4338ca', '#4f46e5', '#6366f1'] } }, { name: 'Teal', value: '20, 184, 166', hex: '#14b8a6', gradient: { light: ['#99f6e4', '#5eead4', '#2dd4bf', '#14b8a6'], dark: ['#0f766e', '#0d9488', '#14b8a6', '#2dd4bf'] } }, { name: 'Rose', value: '225, 29, 72', hex: '#e11d48', gradient: { light: ['#fecdd3', '#fda4af', '#fb7185', '#f43f5e'], dark: ['#881337', '#be123c', '#f43f5e', '#fb7185'] } }, { name: 'Amber', value: '217, 119, 6', hex: '#d97706', gradient: { light: ['#fde68a', '#fcd34d', '#fbbf24', '#f59e0b'], dark: ['#78350f', '#b45309', '#f59e0b', '#fbbf24'] } }, { name: 'Sky', value: '2, 132, 199', hex: '#0284c7', gradient: { light: ['#bae6fd', '#7dd3fc', '#38bdf8', '#0ea5e9'], dark: ['#0c4a6e', '#0369a1', '#0ea5e9', '#38bdf8'] } }, { name: 'Cyan', value: '6, 182, 212', hex: '#06b6d4', gradient: { light: ['#a5f3fc', '#67e8f9', '#22d3ee', '#06b6d4'], dark: ['#155e75', '#0e7490', '#06b6d4', '#22d3ee'] } }, { name: 'Pink', value: '219, 39, 119', hex: '#db2777', gradient: { light: ['#fbcfe8', '#f9a8d4', '#f472b6', '#ec4899'], dark: ['#831843', '#9d174d', '#db2777', '#ec4899'] } }, { name: 'Orange', value: '234, 88, 12', hex: '#ea580c', gradient: { light: ['#fed7aa', '#fdba74', '#fdba74', '#f97316'], dark: ['#7c2d12', '#9a3412', '#ea580c', '#f97316'] } }, { name: 'Purple', value: '147, 51, 234', hex: '#9333ea', gradient: { light: ['#e9d5ff', '#d8b4fe', '#c084fc', '#a855f7'], dark: ['#581c87', '#6b21a8', '#9333ea', '#a855f7'] } }, { name: 'Emerald', value: '5, 150, 105', hex: '#059669', gradient: { light: ['#a7f3d0', '#6ee7b7', '#34d399', '#10b981'], dark: ['#064e3b', '#065f46', '#059669', '#10b981'] } } ];
        const FONT_COMBINATIONS = { 'default1': { title: 'DM Serif Display', body: 'DM Sans' }, 'default2': { title: 'Montserrat', body: 'Lexend' } };

        // --- UTILITY FUNCTIONS ---
        function getLocalStorageSetting(k, d) { try { const s = JSON.parse(localStorage.getItem(SETTINGS_KEY)); return s && s[k] !== undefined ? s[k] : d; } catch { return d; } }
        function setLocalStorageSetting(k, v) { try { const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}'); s[k] = v; localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); } catch {} }
        function speak(text, lang = 'en-US') { if (window.speechSynthesis && text) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = lang; window.speechSynthesis.speak(u); } }
        function playHaptic(success) { if (!disableVibration && navigator.vibrate) navigator.vibrate(success ? 50 : [50, 50, 50]); }

        // --- READ MODE ---
        function toggleReadMode() {
            isReadMode = !isReadMode;
            document.body.classList.toggle('read-mode', isReadMode);
            playHaptic(true);
        }

        // --- SPEECH RECOGNITION ---
        function setupSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false; recognition.interimResults = true; recognition.lang = 'en-US';
                recognition.onstart = () => { micButton.classList.add('mic-active'); grammarInput.placeholder = "Listening..."; };
                recognition.onend = () => { micButton.classList.remove('mic-active'); grammarInput.placeholder = "Start writing here..."; };
                recognition.onresult = (e) => { let f = ''; for (let i = e.resultIndex; i < e.results.length; ++i) { if (e.results[i].isFinal) f += e.results[i][0].transcript; else grammarInput.value = e.results[i][0].transcript; } if (f) grammarInput.value = f; };
                recognition.onerror = (e) => { console.error("Mic Error:", e.error); micButton.classList.remove('mic-active'); alert("Microphone error: " + e.error + ". Please check permissions."); };
            } else { micButton.style.display = 'none'; }
        }
        function toggleMic() { if (!recognition) { alert("Speech recognition not supported in this browser."); return; } try { recognition.start(); playHaptic(true); } catch (e) { recognition.stop(); } }

        // --- CLIPBOARD ---
        async function copyToClipboard(text, btnElement) {
            try { await navigator.clipboard.writeText(text); playHaptic(true); const originalHTML = btnElement.innerHTML; btnElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><polyline points="20 6 9 17 4 12"/></svg>`; setTimeout(() => btnElement.innerHTML = originalHTML, 2000); } 
            catch (err) { console.error('Copy failed:', err); alert("Copy failed. Check browser permissions."); }
        }

        // --- GRAMMAR API ---
        
async function checkGrammar() {
    const text = grammarInput.value.trim();
    if (!text) { grammarInput.focus(); return; }

    checkGrammarBtn.disabled = true;
    grammarLoading.classList.remove('hidden');
    grammarResults.classList.add('hidden');

    try {
        const params = new URLSearchParams();
        params.append('text', text);
        params.append('language', 'en-US');
        params.append('enabledOnly', 'true');

        const response = await fetch('https://cors.isomorphic-git.org/https://api.languagetool.org/v2/check', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString(),
        });

        const data = await response.json();

        let corrected = text;
        for (let match of data.matches.reverse()) {
            if (match.replacements.length > 0) {
                corrected =
                    corrected.slice(0, match.offset) +
                    match.replacements[0].value +
                    corrected.slice(match.offset + match.length);
            }
        }

        const result = {
            status: data.matches.length === 0 ? "correct" : "incorrect",
            corrected,
            explanationEN: data.matches.length === 0 
                ? "Your sentence is correct." 
                : data.matches[0].message,
            explanationTE: data.matches.length === 0
                ? "మీ వాక్యం సరిగా ఉంది."
                : "తప్పు: " + data.matches[0].message
        };

        displayResults(result);

    } catch (e) {
        alert("Check failed. Internet problem or API blocked.");
        console.error(e);
    } finally {
        checkGrammarBtn.disabled = false;
        grammarLoading.classList.add('hidden');
    }
}


// --- INITIALIZATION ---
        window.onload = () => {
            settingsModal = document.getElementById('settings-modal'); themeToggle = document.getElementById('theme-toggle'); themeIconLight = document.getElementById('theme-icon-light'); themeIconDark = document.getElementById('theme-icon-dark'); themeIconSystem = document.getElementById('theme-icon-system'); readModeToggle = document.getElementById('read-mode-toggle');
            bodyFontBtn = document.getElementById('body-font-button'); titleFontBtn = document.getElementById('title-font-button'); colorBtn = document.getElementById('color-button'); currentBodyFont = document.getElementById('current-body-font'); currentTitleFont = document.getElementById('current-title-font'); currentAccentColor = document.getElementById('current-accent-color'); colorPreview = document.getElementById('color-preview');
            toggleAudioCheckbox = document.getElementById('toggle-audio'); toggleHapticsCheckbox = document.getElementById('toggle-haptics'); themeLightBtn = document.getElementById('theme-light'); themeDarkBtn = document.getElementById('theme-dark'); themeSystemBtn = document.getElementById('theme-system');
            contrastDefaultBtn = document.getElementById('contrast-default'); contrastHighBtn = document.getElementById('contrast-high');
            selectionModal = document.getElementById('selection-modal'); modalTitle = document.getElementById('modal-title'); modalOptions = document.getElementById('modal-options');
            grammarInput = document.getElementById('grammar-input'); micButton = document.getElementById('mic-button'); checkGrammarBtn = document.getElementById('check-grammar-btn'); grammarLoading = document.getElementById('grammar-loading'); grammarResults = document.getElementById('grammar-results');
            grammarStatus = document.getElementById('grammar-status'); correctionCard = document.getElementById('correction-card'); correctedTextEl = document.getElementById('corrected-text'); speakCorrectedBtn = document.getElementById('speak-corrected'); copyCorrectedBtn = document.getElementById('copy-corrected');
            expEnEl = document.getElementById('exp-en'); expTeEl = document.getElementById('exp-te'); speakExpEnBtn = document.getElementById('speak-exp-en'); speakExpTeBtn = document.getElementById('speak-exp-te');

            document.getElementById('settings-button').addEventListener('click', () => settingsModal.classList.remove('hidden'));
            document.getElementById('close-settings-modal').addEventListener('click', () => settingsModal.classList.add('hidden'));
            document.getElementById('close-selection-modal').addEventListener('click', () => selectionModal.classList.add('hidden'));
            themeToggle.addEventListener('click', cycleTheme); readModeToggle.addEventListener('click', toggleReadMode);
            bodyFontBtn.addEventListener('click', () => openSelectionModal('bodyFont')); titleFontBtn.addEventListener('click', () => openSelectionModal('titleFont')); colorBtn.addEventListener('click', () => openSelectionModal('color'));
            micButton.addEventListener('click', toggleMic); checkGrammarBtn.addEventListener('click', checkGrammar);
            grammarInput.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); checkGrammar(); } });
            systemPrefersDark.addEventListener('change', (e) => { if (getLocalStorageSetting('theme', 'system') === 'system') applyTheme('system'); });

            setupSpeechRecognition(); 
            loadInitialSettings();
        };

        // --- SETTINGS LOGIC ---
        function loadInitialSettings() { applyTheme(getLocalStorageSetting('theme', 'system')); applyContrast(getLocalStorageSetting('contrast', 'default')); window.applyFontCombination(getLocalStorageSetting('lastFontCombo', 'default2')); applyAccentColor(getLocalStorageSetting('colorTheme', 'Indigo')); disableSound = getLocalStorageSetting('disableSound', false); disableVibration = getLocalStorageSetting('disableVibration', false); updateSettingsUI(); }
        function applyTheme(t) { document.documentElement.classList.toggle('dark', t === 'dark' || (t === 'system' && systemPrefersDark.matches)); [themeIconLight, themeIconDark, themeIconSystem].forEach(i => i.classList.add('hidden')); if (t === 'light') themeIconLight.classList.remove('hidden'); else if (t === 'dark') themeIconDark.classList.remove('hidden'); else themeIconSystem.classList.remove('hidden'); setLocalStorageSetting('theme', t); updateSettingsUI(); applyAccentColor(getLocalStorageSetting('colorTheme', 'Indigo')); }
        function cycleTheme() { const t = getLocalStorageSetting('theme', 'system'); applyTheme(t === 'light' ? 'dark' : t === 'dark' ? 'system' : 'light'); }
        function applyAccentColor(n) { const t = COLOR_THEMES.find(x => x.name === n) || COLOR_THEMES[0]; const isDark = document.documentElement.classList.contains('dark'); const g = t.gradient[isDark ? 'dark' : 'light']; document.documentElement.style.setProperty('--accent-color-rgb', t.value); document.documentElement.style.setProperty('--accent-color-hex', t.hex); for(let i=0;i<4;i++) document.documentElement.style.setProperty(`--bg-grad-color${i+1}`, g[i]); setLocalStorageSetting('colorTheme', n); updateSettingsUI(); }
        function applyContrast(c) { textContrast = c; document.body.setAttribute('data-contrast', c); setLocalStorageSetting('contrast', c); updateSettingsUI(); }
        window.applyFontCombination = function(c) { const combo = FONT_COMBINATIONS[c] || FONT_COMBINATIONS['default2']; document.documentElement.style.setProperty('--title-font', combo.title); document.documentElement.style.setProperty('--body-font', combo.body); setLocalStorageSetting('bodyFont', combo.body); setLocalStorageSetting('titleFont', combo.title); setLocalStorageSetting('lastFontCombo', c); updateSettingsUI(); }
        window.handleSelectionChange = function(t, v) { if(t==='theme')applyTheme(v); else if(t==='contrast')applyContrast(v); else if(t==='color')applyAccentColor(v); else if(t==='toggleAudio'){disableSound=!disableSound;setLocalStorageSetting('disableSound',disableSound);} else if(t==='toggleHaptics'){disableVibration=!disableVibration;setLocalStorageSetting('disableVibration',disableVibration);} else if (t==='bodyFont' || t==='titleFont') { /* simplified */ } if(!t.startsWith('toggle')&&t!=='theme') selectionModal.classList.add('hidden'); updateSettingsUI(); }
        
        function updateSettingsUI() {
            currentBodyFont.textContent = getLocalStorageSetting('bodyFont'); 
            currentTitleFont.textContent = getLocalStorageSetting('titleFont');
            const tn = getLocalStorageSetting('colorTheme', 'Indigo'); 
            currentAccentColor.textContent = tn; 
            colorPreview.style.backgroundColor = (COLOR_THEMES.find(t => t.name === tn) || COLOR_THEMES[0]).hex;
            toggleAudioCheckbox.checked = disableSound; 
            
            // *** CHANGED: 'disableVVibration' to 'disableVibration' ***
            toggleHapticsCheckbox.checked = disableVibration; 
            
            const ct = getLocalStorageSetting('theme', 'system'); 
            themeLightBtn.classList.toggle('active', ct==='light'); 
            themeDarkBtn.classList.toggle('active', ct==='dark'); 
            themeSystemBtn.classList.toggle('active', ct==='system');
            contrastDefaultBtn.classList.toggle('active', textContrast === 'default'); 
            contrastHighBtn.classList.toggle('active', textContrast === 'high');
            const lc = getLocalStorageSetting('lastFontCombo', 'default2'); 
            document.querySelectorAll('#font-combo-btns button').forEach(b => b.classList.toggle('active', b.dataset.combo === lc));
        }
        
        window.openSelectionModal = function(type) {
            settingsModal.classList.add('hidden'); selectionModal.classList.remove('hidden'); let h = ''; const btn = 'w-full text-left p-3 rounded-lg selection-button text-white';
            if(type.endsWith('Font')) { modalTitle.textContent = `Select ${type.replace('Font','')}`; const opts=FONT_OPTIONS[type.replace('Font','')], curr=getLocalStorageSetting(type); h=opts.map(o=>`<button class="${btn} opacity-50 cursor-not-allowed" disabled title="Please use Font Combinations above">${o.label} (Use Combo)</button>`).join(''); }
            else if(type==='color') { modalTitle.textContent = 'Accent Color'; const curr=getLocalStorageSetting('colorTheme'); h=COLOR_THEMES.map(t=>`<button onclick="handleSelectionChange('color','${t.name}')" class="${btn} ${curr===t.name?'active':''} flex justify-between items-center"><span>${t.name}</span><span class="w-6 h-6 rounded-full border border-white/20" style="background-color:${t.hex}"></span></button>`).join(''); }
            modalOptions.innerHTML = h;
        }
    </script>
</body>
</html>
